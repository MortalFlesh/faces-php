---
# Step 2: Traffic Splitting with HTTPRoute
# This adds smiley2 and color2 services, then configures HTTPRoute to split traffic 50/50
#
# Prerequisites: step1.yaml must be applied first
#
# Apply with:
#   kubectl apply -f step2.yaml

---
# Smiley2 deployment - returns heart eyes emoji (üòç)
apiVersion: apps/v1
kind: Deployment
metadata:
    name: smiley2
    namespace: faces-mf
spec:
    replicas: 2
    selector:
        matchLabels:
            app: smiley2
    template:
        metadata:
            labels:
                app: smiley2
        spec:
            containers:
                - name: smiley2
                  image: ghcr.io/mortalflesh/faces-face:1.5.0
                  env:
                      - name: ROLE
                        value: "smiley"
                      - name: SMILEY
                        value: "love"
                  ports:
                      - containerPort: 8080
                        name: http
                  readinessProbe:
                      httpGet:
                          path: /health-check
                          port: http
                      initialDelaySeconds: 3
                  resources:
                      requests:
                          cpu: 50m
                          memory: 64Mi
                      limits:
                          cpu: 100m
                          memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
    name: smiley2
    namespace: faces-mf
spec:
    selector:
        app: smiley2
    ports:
        - port: 80
          targetPort: 8080
          name: http
---
# Color2 deployment - returns cyan background
apiVersion: apps/v1
kind: Deployment
metadata:
    name: color2
    namespace: faces-mf
spec:
    replicas: 2
    selector:
        matchLabels:
            app: color2
    template:
        metadata:
            labels:
                app: color2
        spec:
            containers:
                - name: color2
                  image: ghcr.io/mortalflesh/faces-face:1.5.0
                  env:
                      - name: ROLE
                        value: "color"
                      - name: COLOR
                        value: "cyan"
                  ports:
                      - containerPort: 8080
                        name: http
                  readinessProbe:
                      httpGet:
                          path: /health-check
                          port: http
                      initialDelaySeconds: 3
                  resources:
                      requests:
                          cpu: 50m
                          memory: 64Mi
                      limits:
                          cpu: 100m
                          memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
    name: color2
    namespace: faces-mf
spec:
    selector:
        app: color2
    ports:
        - port: 80
          targetPort: 8080
          name: http
---
# HTTPRoute for external access to smiley2
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: faces-smiley2-route
    namespace: faces-mf
spec:
    parentRefs:
        - name: traefik-gateway
          namespace: kube-system
          sectionName: web
    hostnames:
        - faces-mf.adun
    rules:
        - matches:
              - path:
                    type: PathPrefix
                    value: /smiley2
          backendRefs:
              - name: smiley2
                port: 80
---
# HTTPRoute for external access to color2
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: faces-color2-route
    namespace: faces-mf
spec:
    parentRefs:
        - name: traefik-gateway
          namespace: kube-system
          sectionName: web
    hostnames:
        - faces-mf.adun
    rules:
        - matches:
              - path:
                    type: PathPrefix
                    value: /color2
          backendRefs:
              - name: color2
                port: 80
---
# Smiley canary routing - splits internal traffic 50/50 between smiley and smiley2
# This intercepts traffic from face service to "smiley" service
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: smiley-canary
    namespace: faces-mf
spec:
    parentRefs:
        - name: smiley
          kind: Service
          group: ""
          port: 80
    rules:
        - backendRefs:
              - name: smiley
                port: 80
                weight: 50
              - name: smiley2
                port: 80
                weight: 50
---
# Color canary routing - splits internal traffic 50/50 between color and color2
# This intercepts traffic from face service to "color" service
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
    name: color-canary
    namespace: faces-mf
spec:
    parentRefs:
        - name: color
          kind: Service
          group: ""
          port: 80
    rules:
        - backendRefs:
              - name: color
                port: 80
                weight: 50
              - name: color2
                port: 80
                weight: 50

