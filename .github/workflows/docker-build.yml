name: Build and Push Docker Images

on:
  push:
    tags:
      - '*'

env:
  REGISTRY: ghcr.io
  DASHBOARD_IMAGE_NAME: ${{ github.repository_owner }}/faces-dashboard
  API_IMAGE_NAME: ${{ github.repository_owner }}/faces-face

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for dashboard
        id: meta-dashboard
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.DASHBOARD_IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},prefix=
            type=semver,pattern={{major}}.{{minor}},prefix=
            type=semver,pattern={{major}},prefix=
            type=raw,value=latest

      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.API_IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},prefix=
            type=semver,pattern={{major}}.{{minor}},prefix=
            type=semver,pattern={{major}},prefix=
            type=raw,value=latest

      - name: Build and push dashboard image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./dockers/dashboard.Dockerfile
          push: true
          tags: ${{ steps.meta-dashboard.outputs.tags }}
          labels: ${{ steps.meta-dashboard.outputs.labels }}

      - name: Build and push face image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./dockers/face.Dockerfile
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Extract changelog for current version
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          # Extract changelog content for this version
          if [ -f CHANGELOG.md ]; then
            # Get content between this version and the next version heading or end of file
            CHANGELOG=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' | tail -n +2)
            
            # If no content found, try without brackets
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG=$(sed -n "/## ${VERSION}/,/## /p" CHANGELOG.md | sed '$d' | tail -n +2)
            fi
            
            # If still no content, use a default message
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="Release version ${VERSION}"
            fi
          else
            CHANGELOG="Release version ${VERSION}"
          fi
          
          # Save to output using heredoc to handle multi-line content
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Docker Images
            
            The following Docker images have been published to GitHub Container Registry:
            
            ### Dashboard
            ```
            docker pull ${{ env.REGISTRY }}/${{ env.DASHBOARD_IMAGE_NAME }}:${{ steps.version.outputs.version }}
            docker pull ${{ env.REGISTRY }}/${{ env.DASHBOARD_IMAGE_NAME }}:latest
            ```
            
            ### Face API
            ```
            docker pull ${{ env.REGISTRY }}/${{ env.API_IMAGE_NAME }}:${{ steps.version.outputs.version }}
            docker pull ${{ env.REGISTRY }}/${{ env.API_IMAGE_NAME }}:latest
            ```
            
            ## Changelog
            
            ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: false
